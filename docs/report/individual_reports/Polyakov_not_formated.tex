\newpage

\subsection{Введение}

Задачей поставленной на данный семестр стало написание автоматизированного экспертизного комплекса, имеющего следующие возможности: 

\begin{enumerate}
\item сбор и анализ событий системных журналов операционной системы;
\item сбор и анализ информации из журналов истории браузеров;
\item сбор и анализ истории переписки мессенджеров;
\item сбор и анализ событий журнальных файлов приложений;
\item обнаружение сетевых параметров системы;
\item поиск файлов по имени;
\end{enumerate}

Моя задача на данный семестр . 

\begin{enumerate}
\item сбор и анализ истории переписки пользователей системы Windows из Pidgin и Skype;
\item написание автоматизированных модулей для сбора истории переписки пользователей системы Windows из таких программ как Pidgin и Skype;
\end{enumerate}

Для упрощения разобьем задачу, на подзадачи
\begin{enumerate}
\item определить места хранения файлов с личной перепиской пользователя
\item определить формат файлов переписки
\item разбор найденных файлов
\item автоматизировать процесс поиска файлов
\item производить сохранение полученных информации формат XML
\end{enumerate}

\subsection{Определить места хранения файлов с личной перепиской пользователя.}

\subsubsection{Pidgin:}
Определение месторасположения файлов переписки происходит следующим образом. Для при монтированному образу запускается модуль который сужает область поиска, сканируя только нужные места в образе . 

По умолчанию файлы располагаются в директориях, для разных операционных систем возможны незначительные изменения: 
%Тут можно как таблицу, а можно и забить..
Windows Vista\/7\/8 :: C:\\Users\\username\\AppData\\Roaming\\.purple\\logs
Windows XP 		:: C:\\Documents and Settings\\username\\Application Data\\.purple
Windows 98\/ME 	:: C:\\Windows\\Profiles\\username\\.purple
Linux(Ubuntu) 	:: \/home\/username\/.purple\/logs
%конец таблицы
Основная интересующая нас информация хранится в файлах с такой маской имени YEAR-MONTH-DATE.TIME.html (например 2013-03-02.004915+0700NOVT.htm)\\

\subsubsection{Skype:}
По умолчанию файлы располагаются в директориях, для разных операционных систем возможны незначительные изменения: 
%Тут можно как таблицу, а можно и забить..
Windows Vista\/7\/8 :: C:\\Users\\username\\AppData\\Roaming\\Skype[4]
Windows XP 		:: C:\\Documents and Settings\\username\\Application Data\\Skype[4]
Linux(Ubuntu) 	:: \/home\/username\/.Skype[4]
%конец таблицы
Основная интересующая нас информация находится в main.db.\\

%Здесь блок схема алгоритма простого поиска.

\subsection{Определить формат хранения переписки.}

Приложение «skype» хранит переписку на локальных машинах пользователей или же возможна синхронизация с машин других пользователей [1]. Формат хранения: реляционная база данных основная на СУБД SQLite.\\ 
Но база данных «main.db» не является единственным местом хранения информации, Skype сохраняет сведения о работе программы во временных файлах (chatsync). Эти файлы имеют расширение «.dat» и цифра-буквенные имена (например «0172b0a519e2c584»).[2]

Приложение «pidgin» поддерживает перечисленные ниже протоколы:[5]

\"AIM\"
\"Bonjour\"
\"Gadu-Gadu
\"Google Talk\"
\"Groupwise\"
\"ICQ\"
\"IRC\"
\"MSN\"
\"MXit\"
\"MySpaceIM\"
\"SILC\"
\"SIMPLE\"
\"Sametime\"
\"XMPP\"
\"Yahoo!\"
\"Zephyr\"

Соответтственно все подлюченные аккаунты всех выше перечисленных протоколов хранятся как лог файлы на локальной машине пользователя в формате HTML и TXT. По умолчанию лог файлы хранятся в .HTML файле. Настройки программы, пользователя и подключенных аккаунтов в XML.
Примечание: Кроме account.xml - он хранит не шифрованные пароли для всех подключенных чатов.[3]

\subsection{Разбор найденных файлов.}

В зависимости от обрабатываемых логов, запускается нужный модуль.\\ 
\subsubsection {Skype.}
Структура рассматриваемого файла.
main.db  содержит 18 таблиц. и ещё немного статистики.
\"DbMeta\"   
\"Contacts\"   
\"LegacyMessages\"
\"Calls\"     
\"Accounts\"   
\"Transfers\"   
\"Voicemails\"   
\"Chats\"      
\"Messages\"   
\"ContactGroups\"  
\"Videos\"   
\"SMSes\"
\"CallMembers\"   
\"ChatMembers\"   
\"Alerts\"
\"Conversations\"     
\"Participants\"   
\"VideoMessages\"

Таблицы которые были рассмотрены, на данный момент:    
 \begin{enumerate}
\item Contacts
\item Messages
\item Chats
\item Calls
\item CallMembers
\item Conversations
\end{enumerate}

В таблице Contacts находятся все контакты, причем даже те, что были удалены, и уже не показываются в клиенте.

select skypename, 
       fullname, 
       languages, 
       country,
       city 
  from contacts

В таблицах Calls и CallMembers содержатся, соответственно, история звонков и их участников.

select calls.id as \"ID разговора\",
       coalesce(contacts.displayname, accounts.fullname) as \"Инициатор\",
       strftime(\'\%d.\%m.\%Y \%H:\%M:\%S\',calls.begin_timestamp, \'unixepoch\', \'localtime\') as \"Дата начала\",
       time(calls.duration, \'unixepoch\') as \"Длительность\",
       callmembers.dispname as \"Подключенный участник\",
       strftime(\'\%d.\%m.\%Y \%H:\%M:\%S\',callmembers.start_timestamp, \'unixepoch\', \'localtime\') as \"Дата подключения\",
       time(callmembers.call_duration, \'unixepoch\') as \"Длительность подключения\"
  from calls
       inner join callmembers on calls.id = callmembers.call_db_id
       left  join contacts on calls.host_identity = contacts.skypename
       left  join accounts on calls.host_identity = accounts.skypename

И, наконец, в таблицах Conversations и Messages содержатся данные переписки и сами сообщения.

select conversations.id as \"ID переписки\", 
       conversations.displayname as \"Участники переписки\", 
       messages.from_dispname as \"Автор сообщения\",  
       strftime(\'\%d.\%m.\%Y \%H:\%M:\%S\',messages.timestamp, \'unixepoch\', \'localtime\') as \"Время сообщения\", 
       messages.body_xml as \"Текст сообщения\"
  from conversations
       inner join messages on conversations.id = messages.convo_id
order by messages.timestamp

Для доступа ко всему содержимому базы достаточно иметь доступ к самому файлу — содержимое базы никак не шифруется и не защищается, так что любой человек, который сможет получить доступ к вашему профилю Windows, сможет найти список контактов, просмотреть историю звонков и прочитать всю переписку. 

\subsubsection Pidgin. 

Структура рассматриваемого файла.\\ 
У каждого лог файла есть заголовок находящийся между тегов title. В котором записан ID_Chat, дата начала переписки, логин пользователя и используемый протокол.\\
Затем идет \"тело\" в котором описывается обмен сообщениями в формате, время, автор сообщения и сообщение.\\

Пример \"Заголовка\" <head><meta http-equiv=\"content-type\" content=\"text\/html; charset=UTF-8\"><title>Conversation with 0dpkhcz6clufs2kozj82uqif30@public.talk.google.com at Чт. 24 окт. 2013 23:40:21 on user.fox@gmail.com/ (jabber)</title></head>\\

Пример \"Тела\" <font color=\"#16569E\"><font size=\"2\">(23:44:52)</font> <b>user.fox@gmail.com/95C9F047:</b></font> Hello) <br/>\\

Точно так же из полученного списка, найденные файлы поочередно открываются, на чтение. Разбор открытого файла решено осуществлять при помощи регулярных выражений, описанных в класс QRegExp.\\


Пример регулярного выражения, для работы с лог-файлами в формате .HTML

QRegExp rxHead(\".\*h3.\*with (.\*) at (.\*) on (.\*)\\/ \\((.*)\\)")

QRegExp rxBody(\".\*(\\d{2\}:\\d\\{2\}:\\d\\{2\}).\*b\\\>(.*):\\\<\\\/b.\*font\\>(.\*)\\\<br\")


Пример регулярного выражения, для работы с лог-файлами в формате .TXT

QRegExp rxHead(\".\*with (.\*) at (.\*) on (.\*)\\\/ \\((.\*)\\)\")

QRegExp rxBody(\"\\((\\d\\{2\}:\\d\\{2\}:\\d\\{2\})\\)[ ]\*(.\*)\:(.\*)\$\")

%Здесь блок схема алгоритма парсинга файлов пиджина

\subsection{Aвтоматизировать процесс поиска журнальных файлов}

Для автоматизации процесса решено написать программный комплекс с подключаемыми модулями. Основа комплекса написана на языке С++ с использованием кросс-платформенного фреймворка Qt.
Qt позволяет запускать написанное с его помощью ПО в большинстве современных операционных систем путём простой компиляции программы для каждой ОС без изменения исходного кода.\\
Данный фреймворк включает в себя все основные классы, которые могут потребоваться при разработке прикладного программного обеспечения, начиная от элементов графического интерфейса и заканчивая классами для работы с сетью, базами данных и XML. Qt является полностью объектно-ориентированным, легко расширяемым и поддерживающим технику компонентного программирования.

Для сканирования образа на наличие интересующих лог файлов использовался класс QDirIterator. После вызова происходит поочередный обход по каждому файлу в директории и под директории. Проверка полученного полного пути к файлу осуществляется регулярным выражением, если условие выполняется, происходит добавление в список обрабатываемых файлов. 


\subsection{Сохранение полученного в XML.}

Сохранение полученных данных происходит в ранее выбранный формат XML(Extensible Markup Language). Для этого используется класс QXmlStreamReader и QxmlStreamWriter.
Класс QXmlStreamWriter представляет XML писателя с простым потоковым API.\\

QXmlStreamWriter работает в связке с QXmlStreamReader для записи XML. Как и связанный класс, он работает с QIODevice, определённым с помощью setDevice().\\

Сохранение данных реализованно в классе WriteMessage. В методе WriteMessages, структура которого представлена на UML диаграмме. %тут отсылка на диаграмму которую Димка херачил!)% 

Стуктура сохраняемого документа:
\subsubsection{Pidgin}
  Пролог XML документа. Все документы XML начинаются с пролога (prolog). Пролог сообщает, что документ написан на XML, а также указывает, какая версия XML при этом использовалась.  
  Элемент Messages с атрибутом Messenger, ему присваивается имя рассматриваемого приложения.
  Элемент INFO содержащий атрибуты chathID, account, data, protocol которым присваивается, соответственно: идентификатор чата, полная дата в формате  День.Число Месяц. Год Час:Мин:Сек, аккаунт с которого происходил обмен сообщениями и протокол используемый для передачи сообщений. 
  Элемент MESSAGE содержащий атрибуты author, dataTime, message.
\subsubsection{Skype}
  Пролог XML документа. Все документы XML начинаются с пролога (prolog). Пролог сообщает, что документ написан на XML, а также указывает, какая версия XML при этом использовалась.  
  Элемент Messages с атрибутом Messenger, ему присваивается имя рассматриваемого приложения.
  Для каждого файла БД находящейся в обрабатываемом списке создается элемент info account содержащий атрибуты skypeName, fullName, emails, ipcountry которым присваивается, соответственно: логин пользователя Skype, его полное имя, email (не шифрованный), геолокация ip-адреса.  
  Элемент contact содержащий атрибуты skypeName, fullName ,languages ,country ,city.
  
  На текущий момент полностью реализован импорт контактной книги из приложения Skype, импорт звонков и переписки находится в режиме разработки.
  

\subsection{Список использованной литературы:}
1 - Ответ на вопрос \"Хранение логов Skype\" в официальном сообществе - http://community.skype.com/t5/Security-Privacy-Trust-and/Is-chat-history-stored-on-Skype-servers/td-p/472379
2 - Криминалистическое исследование поврежденных и частично удаленных баз Skype http://computer-forensics-lab.org/pdf/00030.pdf
3 - Ответ на вопрос \"В каком виде хранит пароли мессенджер Pidgin\" в оффициальном сообществе - https://developer.pidgin.im/wiki/PlainTextPasswords
4 - Ответ на вопрос \"Место хранения логов  Skype\" в официальном сообществе - http://community.skype.com/t5/Linux/transfer-Skype-History-from-Ubuntu-to-Windows-7/td-p/1709097
5 - Список поддерживаемых протоколов Pidgin https:\/\/developer.pidgin.im\/wiki\/Protocol\%20Specific\%20Questions